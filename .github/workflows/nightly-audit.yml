# =============================================================================
# Nightly Infrastructure Audit
# Runs every night to verify infrastructure compliance
# =============================================================================

name: Nightly Audit ðŸ”

on:
  schedule:
    # Run at 2 AM UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  terraform-drift:
    name: Terraform Drift Detection
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sectors/08-aws/infrastructure

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-audit
          aws-region: us-east-1

      - name: Terraform Init
        run: terraform init -backend-config="bucket=turbo-fleet-terraform-state" -backend-config="key=infrastructure/terraform.tfstate" -backend-config="region=us-east-1"

      - name: Terraform Plan (Drift Detection)
        id: drift
        run: |
          terraform plan -var-file=terraform.tfvars -no-color -out=tfplan > plan_output.txt 2>&1
          
          # Check for drift (non-empty plan)
          if grep -q "Plan:" plan_output.txt; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Report Drift
        if: steps.drift.outputs.drift_detected == 'true'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âš ï¸ Terraform Drift Detected",
              "details": "Infrastructure has drifted from desired state. Review and apply changes.",
              "plan_output": "$(cat plan_output.txt | head -100)"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  security-scan:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for Secrets in Code
        run: |
          # Scan for potential secrets
          if grep -r "AKIA[0-9A-Z]\{16\}" . --exclude-dir=.git 2>/dev/null; then
            echo "âŒ Potential AWS access key found"
            exit 1
          fi
          
          if grep -r "ghp_[a-zA-Z0-9]\{36\}" . --exclude-dir=.git 2>/dev/null; then
            echo "âŒ Potential GitHub token found"
            exit 1
          fi
          
          echo "âœ… No secrets detected"

  cost-analysis:
    name: AWS Cost Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-cost-audit
          aws-region: us-east-1

      - name: Get Current Month Costs
        run: |
          # Get Cost Explorer data
          aws ce get-cost-and-usage \
            --time-period Start=$(date -d "$(date +%Y-%m-01)" +%Y-%m-%d) \
            --time-period End=$(date +%Y-%m-%d) \
            --granularity MONTHLY \
            --metrics "BlendedCost" \
            --group-by Type=DIMENSION,Key=SERVICE \
            --query 'ResultsByTime[0].Groups[*].[Keys[0],Metrics.BlendedCost.Amount]' \
            --output table

  compliance-report:
    name: Compliance Report
    runs-on: ubuntu-latest
    needs: [terraform-drift, security-scan, cost-analysis]

    steps:
      - name: Generate Report
        run: |
          echo "## ðŸ” Nightly Compliance Report" > report.md
          echo "" >> report.md
          echo "Date: $(date -u +%Y-%m-%d)" >> report.md
          echo "" >> report.md
          echo "### Terraform Drift: ${{ needs.terraform-drift.result }}" >> report.md
          echo "### Security Scan: ${{ needs.security-scan.result }}" >> report.md
          echo "### Cost Analysis: ${{ needs.cost-analysis.result }}" >> report.md

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: report.md
          retention-days: 30
