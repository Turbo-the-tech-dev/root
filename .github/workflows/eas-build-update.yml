# =============================================================================
# EAS Build & OTA Update Pipeline
# Automated builds and over-the-air updates on merge
# =============================================================================

name: EAS Build & Update ðŸ“±

on:
  push:
    branches: [main, develop]
    paths:
      - 'sectors/19-expo/**'
  pull_request:
    branches: [main]
    paths:
      - 'sectors/19-expo/**'
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        type: choice
        options:
          - development
          - preview
          - production
        default: preview
      platform:
        description: 'Target platform'
        required: true
        type: choice
        options:
          - all
          - ios
          - android
        default: all
      update_message:
        description: 'OTA update message'
        required: false
        type: string
        default: 'Manual trigger'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  WORKING_DIRECTORY: sectors/19-expo

jobs:
  # ===========================================================================
  # Stage 1: Lint & Test
  # ===========================================================================

  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run TypeScript check
        run: npm run type-check

      - name: Run tests
        run: npm test -- --coverage

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-expo
          path: ${{ env.WORKING_DIRECTORY }}/coverage
          retention-days: 7

  # ===========================================================================
  # Stage 2: EAS Update (OTA)
  # ===========================================================================

  eas-update:
    name: EAS OTA Update
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name != 'pull_request'
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    outputs:
      update_id: ${{ steps.update.outputs.update_id }}
      branch: ${{ steps.update.outputs.branch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ env.EXPO_TOKEN }}

      - name: Lint project
        run: npx expo lint

      - name: Create OTA Update
        id: update
        run: |
          BRANCH="${{ github.ref_name == 'main' && 'production' || 'preview' }}"
          
          eas update --branch $BRANCH \
            --message "${{ github.event.inputs.update_message || github.event.head_commit.message }}" \
            --non-interactive \
            --json > update-result.json
          
          UPDATE_ID=$(jq -r '.id' update-result.json)
          echo "update_id=$UPDATE_ID" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          
          cat update-result.json

      - name: Upload Update Result
        uses: actions/upload-artifact@v4
        with:
          name: eas-update-result
          path: ${{ env.WORKING_DIRECTORY }}/update-result.json
          retention-days: 7

  # ===========================================================================
  # Stage 3: EAS Build (Conditional)
  # ===========================================================================

  eas-build:
    name: EAS Build
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    strategy:
      matrix:
        platform: ${{ fromJSON(github.event.inputs.platform == 'all' && '["ios", "android"]' || format('["{0}"]', github.event.inputs.platform)) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ env.EXPO_TOKEN }}

      - name: Run EAS Build
        id: build
        env:
          PROFILE: ${{ github.event.inputs.profile || 'preview' }}
        run: |
          eas build --profile $PROFILE --platform ${{ matrix.platform }} \
            --non-interactive \
            --wait \
            --json > build-result-${{ matrix.platform }}.json
          
          BUILD_ID=$(jq -r '.id' build-result-${{ matrix.platform }}.json)
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "platform=${{ matrix.platform }}" >> $GITHUB_OUTPUT

      - name: Upload Build Result
        uses: actions/upload-artifact@v4
        with:
          name: eas-build-${{ matrix.platform }}
          path: ${{ env.WORKING_DIRECTORY }}/build-result-${{ matrix.platform }}.json
          retention-days: 7

      - name: Notify Slack
        uses: slackapi/slack-github-action@v1
        if: always()
        with:
          payload: |
            {
              "text": "EAS Build ${{ steps.build.outcome }}",
              "platform": "${{ matrix.platform }}",
              "build_id": "${{ steps.build.outputs.build_id }}",
              "commit": "${{ github.sha }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===========================================================================
  # Stage 4: Post-Update Verification
  # ===========================================================================

  verify-update:
    name: Verify OTA Update
    runs-on: ubuntu-latest
    needs: eas-update
    if: always() && needs.eas-update.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Verify Update Manifest
        run: |
          # Check that update manifest is valid
          npx expo-export --dump-sourcemap
          echo "âœ… Update manifest verified"

      - name: Smoke Test
        run: |
          # Basic smoke test for the update
          node -e "
            const manifest = require('./app.json');
            console.log('App slug:', manifest.expo.slug);
            console.log('Version:', manifest.expo.version);
            console.log('âœ… Smoke test passed');
          "
        working-directory: ${{ env.WORKING_DIRECTORY }}
