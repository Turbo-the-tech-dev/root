# =============================================================================
# Terraform Plan - Infrastructure Changes
# Runs on PR to preview infrastructure changes before merge
# =============================================================================

name: Terraform Plan üèóÔ∏è

on:
  pull_request:
    branches: [main]
    paths:
      - 'sectors/08-aws/infrastructure/**/*.tf'
      - 'sectors/08-aws/infrastructure/**/*.tfvars'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sectors/08-aws/infrastructure

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-terraform-plan
          aws-region: us-east-1

      - name: Terraform Init
        run: terraform init -backend-config="bucket=turbo-fleet-terraform-state" -backend-config="key=infrastructure/terraform.tfstate" -backend-config="region=us-east-1"

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan (Staging)
        id: plan-staging
        run: terraform plan -var-file=terraform.tfvars -no-color
        continue-on-error: true

      - name: Terraform Plan (Production)
        id: plan-production
        run: terraform plan -var-file=terraform.tfvars.production -no-color
        continue-on-error: true

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const planStaging = `${{ steps.plan-staging.outputs.stdout }}`;
            const planProduction = `${{ steps.plan-production.outputs.stdout }}`;
            
            const comment = `
            ### üèóÔ∏è Terraform Plan Results
            
            #### Format Check: ${{ steps.fmt.outcome }}
            #### Validate: ${{ steps.validate.outcome }}
            
            <details>
            <summary><strong>Staging Plan</strong></summary>
            
            \`\`\`terraform
            ${planStaging.substring(0, 60000)}
            \`\`\`
            </details>
            
            <details>
            <summary><strong>Production Plan</strong></summary>
            
            \`\`\`terraform
            ${planProduction.substring(0, 60000)}
            \`\`\`
            </details>
            
            *Generated by GitHub Actions*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload Plan as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: sectors/08-aws/infrastructure/tfplan
          retention-days: 7
