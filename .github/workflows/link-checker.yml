# =============================================================================
# Link Checker - Monthly Automated Audit
# Checks all markdown files for broken external links
# =============================================================================

name: Link Checker ðŸ”—

on:
  schedule:
    # Run monthly on the 1st at 3 AM UTC
    - cron: '0 3 1 * *'
  workflow_dispatch:
  pull_request:
    paths:
      - '**/*.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  check-links:
    name: Check Markdown Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install lychee
        run: |
          curl -sSfL https://github.com/lycheeverse/lychee/releases/latest/download/lychee-x86_64-unknown-linux-gnu.tar.gz | tar xz
          sudo mv lychee /usr/local/bin/
          lychee --version

      - name: Check Links (All Markdown Files)
        id: lychee
        run: |
          lychee --verbose --no-progress --exclude-all-private \
            --exclude 'https://github.com/.*' \
            --exclude 'https://img.shields.io/.*' \
            --exclude 'http://localhost.*' \
            --exclude 'https://localhost.*' \
            --timeout 30 \
            --max-retries 3 \
            --retry-wait-time 5 \
            '**/*.md' > link-check-results.txt 2>&1 || true
          
          # Count broken links
          BROKEN_COUNT=$(grep -c "âœ—" link-check-results.txt || echo "0")
          echo "broken_links=$BROKEN_COUNT" >> $GITHUB_OUTPUT
          
          # Show results
          cat link-check-results.txt

      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: link-check-results
          path: link-check-results.txt
          retention-days: 30

      - name: Create Issue if Broken Links Found
        if: steps.lychee.outputs.broken_links > 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const results = fs.readFileSync('link-check-results.txt', 'utf8');
            const brokenCount = '${{ steps.lychee.outputs.broken_links }}';
            
            const body = `
            ## ðŸ”— Broken Links Detected
            
            **Monthly link check found ${brokenCount} broken link(s).**
            
            ### Details
            
            \`\`\`
            ${results.substring(0, 60000)}
            \`\`\`
            
            ### Action Required
            
            1. Review the broken links above
            2. Update or remove dead URLs
            3. Consider adding archive.org fallbacks for important resources
            4. Re-run link checker to verify fixes
            
            ---
            *Generated by GitHub Actions Link Checker*
            *Run: \`gh workflow run "Link Checker ðŸ”—"\` to re-check*
            `;
            
            // Check if similar issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links'
            });
            
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”— Broken Links Detected - ${new Date().toISOString().split('T')[0]}`,
                body: body,
                labels: ['broken-links', 'documentation', 'automated-issue']
              });
            }

      - name: Notify Slack if Broken Links Found
        if: steps.lychee.outputs.broken_links > 0
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸ”— Broken Links Detected",
              "broken_count": "${{ steps.lychee.outputs.broken_links }}",
              "details": "See GitHub issue for full list"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Fail Workflow if Broken Links Found
        if: steps.lychee.outputs.broken_links > 0
        run: exit 1
